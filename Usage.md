# General

В цьому файлі будуть описані усі підходи, фічі та рішення, що були зроблені при створені цього серверу.

## Start

Починаючи з самого початку, я вирішив зробити авторизацію, адже це навіть більш зручно та розширювано, ніж посйно вводити одні й тіж параметри для створення коментарю. Для цього я використав підхід з jwt та пакет passport, бо він дозволяє зручно і швидко розгорнути всі потрібні гварди для Nest.js.

## ORM
У якості ОРМ я обрав прізму, бо вона непогана для роботи з тайпскриптом, адже має автоматичну генерацію типів. А також захищає від SQL injection, адже я у коді не використовував $rawQuery, для прямих запитів до бд. Схему призми я описав коротко: модель користувача з потрібними полями та їх властивостями + поле для аватару, адже на картинці прикладу були аватари, тому я вирішив це реалізувати й у себе. І далі модель коментарів, тут теє все згідно вимог + оскільки коментарі можуть бути залишені під іншими, то я вирішив використати Sel-Relation, тобто посилання на поля своєї ж таблиці. Це потім зручно буде використовуватись у збірі усіх коментарів та їх підкоментарів.

## Auth Module

Для авторизації я використав гварди, вони описані у папці security. Там є гвард для вже авторизованих та для тих, хто хоче увійти в систему. Вони мають бути у бд, якщо їх там немає, то їм буде видавати помилку. Це досить зручно для користувача і полегшує роботу серверу. Також до модулю авторизації увійшов ендпоінт refresh, що оновлювати сесію. Також для створення користувачів я зробив валідацію, вона не дозволяє використовувати кириличні літери.

## File service

Для файлів я створив сервіс, який роздає статику і записує туди нові файли. Шлях до них вказаних у User.avatar i Comment.filePath. Де досить зручно. Також я виніс цю папку за межі src, бо при хожному новому білді старі файли видаляються, що не є досить зручно. Це швидке і зручне рішення, яке я вибрав.

## Comment Module

У модулі коментарів є всього два ендпоінти, які об'єднують увесь потрібний функціонал. Для створення коментарю я описав ДТО, яке вказано у папці, також створив pipe для валідації файлів згідно з вимогами. На жалі, мені не вдолося зробити гарну валідацію для тексту, не зміг написати регексп для тегу посилання з його атрибутами. Так він працює з іншими тегами, тому я його залишив. Також у створені можна вказати parentId, тобто коментар, під яким ми залишаємо коментар.

Для отримання коментарів я реалізував зручне DTO, де параметри можна вказувати виборочно. Можна сортувати по LIFO - default, username, email, як і сказано в умовах. Також можна вибирати сортування за зростанням та спаданням. За допомогою рекурсії я збираю всі коментарі та їх підкоментарі у тій кількості, яка приходить від клієнта. По дефолту сервер віддає 25 первинних коментарів (без parentId), проте користувач можу вказату іншу кількість. Також є пагінацію.

## Docker

Докер збирається вдало, результатом композиції є два контейнера: один для серверу, другий для бд. Вони раняться, працюють правильно, як і на локальній машині. Проте, оскільки це два окремі контейнери, то у DATABASE_URL для призми для їх правильної роботи краще вказувати не локалхост, а postgres, інакше прізма не зможе знайти бд, адже вона знаходиться не у просторі серверу, а у іншому контейнері.

## Conclusion

Паралельно з розробкою я постійно тестив сервер і якихось неправильно працюючих місць не помітив, тому сервер працює і здатен гарно виконувати закладені у нього завдання. Схему бази даних для MySQL Workbench я залишив тут під назвою db schema.